# CUDA settings
# Note: --enable_workspace is no longer needed in Bazel 7.0+
# WORKSPACE support is automatic when WORKSPACE.bazel exists
build --repo_env=HERMETIC_CUDA_VERSION="12.4.0"
build --@rules_cuda//cuda:enable=True
build --@rules_cuda//cuda:compiler=nvcc
build --@rules_cuda//cuda:copts=-allow-unsupported-compiler

# Build settings
build --cxxopt=-std=c++23
build --host_cxxopt=-std=c++23

# Color output
common --color=yes

# Keep going on errors
build --keep_going

# Performance - optimize for Docker containers
build --jobs=auto
# Note: local_ram_resources and local_cpu_resources are set dynamically in Dockerfile
build --experimental_repository_cache_hardlinks
build --disk_cache=/tmp/bazel-cache
# Disable remote cache by default (can be enabled if remote cache is configured)
build --remote_cache=

# Coverage settings
coverage --combined_report=lcov
coverage --instrumentation_filter="//cpp_accelerator/..."
coverage --instrument_test_targets
coverage --build_tests_only
coverage --experimental_generate_llvm_lcov

# Warning suppression for external libraries and generated code
# Suppress warnings from all external repositories (including virtual headers in bazel-out)
# Note: --host_per_file_copt is needed for tools that compile for the host platform
build --per_file_copt=external/.*\.(cc|cpp|h|hpp)@-w
build --per_file_copt=bazel-out/.*/external/.*\.(cc|cpp|h|hpp)@-w
build --per_file_copt=bazel-out/.*/external/.*/.*\.(cc|cpp|h|hpp)@-w
build --host_per_file_copt=external/.*\.(cc|cpp|h|hpp)@-w
build --host_per_file_copt=bazel-out/.*/external/.*\.(cc|cpp|h|hpp)@-w
build --host_per_file_copt=bazel-out/.*/external/.*/.*\.(cc|cpp|h|hpp)@-w

# Note: Specific warnings from external headers (deprecated-declarations, missing-requires)
# are suppressed using #pragma GCC diagnostic directives directly in each file that includes
# external headers. This approach is explicit and local, making it clear which warnings are
# being suppressed and why.

# Suppress warnings from generated protobuf code
build --per_file_copt=.*\.pb\.(cc|h)@-w

# Enable warnings for our own code
# Exclude third_party code from -Werror first (it's external code, must come before general rules)
build --per_file_copt=.*third_party.*\.(cc|cpp|h)@-Wno-error
build --per_file_copt=.*third_party.*\.(cc|cpp|h)@-Wno-missing-field-initializers
build --per_file_copt=^//cpp_accelerator/.*\.(cc|cpp|h)@-Wall
build --per_file_copt=^//cpp_accelerator/.*\.(cc|cpp|h)@-Wextra
build --per_file_copt=^//cpp_accelerator/.*\.(cc|cpp|h)@-Werror
# Exclude cpp_accelerator files that include third_party (they get processed together)
build --per_file_copt=.*stb_image.*@-Wno-error
build --per_file_copt=.*stb_image.*@-Wno-missing-field-initializers
