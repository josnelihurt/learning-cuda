---
- name: Check if repository already exists
  stat:
    path: "{{ app_directory }}/.git"
  register: repo_exists

- name: Remove directory if it exists but is not a git repo
  file:
    path: "{{ app_directory }}"
    state: absent
  when: not repo_exists.stat.exists

- name: Clone repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_directory }}"
    version: "{{ repo_branch }}"
    update: yes
    force: yes
  when: not repo_exists.stat.exists

- name: Update existing repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_directory }}"
    version: "{{ repo_branch }}"
    update: yes
    force: yes
  when: repo_exists.stat.exists

- name: Get last 3 commits
  shell: cd {{ app_directory }} && git log -3 --oneline
  register: git_commits
  changed_when: false

- name: Display status
  debug:
    msg: "Repository cloned to {{ app_directory }}"

- name: Display last 3 commits
  debug:
    msg: "{{ item }}"
  loop: "{{ git_commits.stdout_lines }}"

