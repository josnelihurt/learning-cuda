---
- name: Start services on Cloud VM
  hosts: cloud
  tasks:
    - name: Stop existing containers
      shell: |
        cd {{ app_directory }}
        export APP_IMAGE="{{ app_image }}"
        docker compose -f docker-compose.go-cloud.yml down --remove-orphans
      register: stop_result
      failed_when: false
      changed_when: stop_result.rc == 0

    - name: Start services with docker compose
      shell: |
        cd {{ app_directory }}
        export APP_IMAGE="{{ app_image }}"
        docker compose -f docker-compose.go-cloud.yml up -d
      register: docker_up
      failed_when: docker_up.rc != 0

    - name: Display docker up output
      debug:
        msg: "{{ item }}"
      loop: "{{ docker_up.stdout_lines }}"
      when: docker_up.stdout_lines is defined

    - name: Display docker up errors
      debug:
        msg: "{{ item }}"
      loop: "{{ docker_up.stderr_lines }}"
      when: docker_up.stderr_lines is defined
