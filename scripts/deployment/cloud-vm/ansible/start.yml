---
- name: Start services on Cloud VM
  hosts: cloud
  tasks:
    - name: Verify .secrets directory exists
      stat:
        path: "{{ app_directory }}/.secrets"
      register: secrets_check

    - name: Fail if secrets don't exist
      fail:
        msg: ".secrets directory not found at {{ app_directory }}/.secrets"
      when: not secrets_check.stat.exists

    - name: Verify docker-compose.yml exists
      stat:
        path: "{{ app_directory }}/docker-compose.yml"
      register: compose_check

    - name: Fail if docker-compose.yml doesn't exist
      fail:
        msg: "docker-compose.yml not found at {{ app_directory }}"
      when: not compose_check.stat.exists

    - name: List .secrets files
      shell: ls -1 {{ app_directory }}/.secrets/*.env
      register: secrets_files
      changed_when: false
      failed_when: false

    - name: Display secrets found
      debug:
        msg: "Found secrets: {{ secrets_files.stdout_lines }}"
      when: secrets_files.rc == 0

    - name: Set APP_IMAGE variable
      set_fact:
        app_image: "{{ lookup('env', 'APP_IMAGE') | default('ghcr.io/josnelihurt/learning-cuda/app:1.4.0-amd64', true) }}"

    - name: Pull latest container images
      shell: |
        cd {{ app_directory }}
        export APP_IMAGE="{{ app_image }}"
        docker compose -f docker-compose.yml pull
      register: docker_pull
      changed_when: "'Downloaded' in docker_pull.stdout or 'Updated' in docker_pull.stdout or 'Pulling' in docker_pull.stdout"
      failed_when: docker_pull.rc != 0

    - name: Stop existing containers
      shell: |
        cd {{ app_directory }}
        export APP_IMAGE="{{ app_image }}"
        docker compose -f docker-compose.yml down --remove-orphans
      register: stop_result
      failed_when: false
      changed_when: stop_result.rc == 0

    - name: Remove any orphaned containers with same names
      shell: |
        docker rm -f cuda-go-server flipt loki-cloud otel-collector-cloud jaeger-cloud 2>/dev/null || true
      register: remove_orphans
      failed_when: false
      changed_when: remove_orphans.rc == 0

    - name: Start services with docker compose
      shell: |
        cd {{ app_directory }}
        export APP_IMAGE="{{ app_image }}"
        docker compose -f docker-compose.yml up -d
      register: docker_up
      failed_when: docker_up.rc != 0

    - name: Display docker up output
      debug:
        msg: "{{ item }}"
      loop: "{{ docker_up.stdout_lines }}"
      when: docker_up.stdout_lines is defined

    - name: Display docker up errors
      debug:
        msg: "{{ item }}"
      loop: "{{ docker_up.stderr_lines }}"
      when: docker_up.stderr_lines is defined

    - name: Wait for services to be up
      shell: cd {{ app_directory }} && docker compose -f docker-compose.yml ps
      register: services_status
      retries: 30
      delay: 5
      changed_when: false
      failed_when: false

    - name: Display services status
      debug:
        msg: "{{ item }}"
      loop: "{{ services_status.stdout_lines }}"

    - name: Verify no services exited
      fail:
        msg: "Some services have exited. Check the status above."
      when: "'Exited' in services_status.stdout"

    - name: Check if Grafana API token exists in secrets
      shell: |
        if [ -f {{ app_directory }}/.secrets/production.env ]; then
          grep -q "^GRAFANA_API_TOKEN=" {{ app_directory }}/.secrets/production.env && grep -v "^GRAFANA_API_TOKEN=$" {{ app_directory }}/.secrets/production.env | grep -q "^GRAFANA_API_TOKEN=" || echo "missing"
        else
          echo "missing"
        fi
      register: token_check
      changed_when: false
      failed_when: false

    - name: Generate Grafana API token if missing
      shell: |
        cd {{ app_directory }}
        export GRAFANA_URL=https://grafana-cuda-demo.josnelihurt.me
        export SECRETS_FILE={{ app_directory }}/.secrets/production.env
        if [ -f {{ app_directory }}/.secrets/production.env ]; then
          source {{ app_directory }}/.secrets/production.env
        fi
        export GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
        export GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
        {{ project_root }}/scripts/deployment/cloud-vm/generate-grafana-token.sh
      register: token_generation
      when: token_check.stdout == "missing"
      changed_when: token_generation.rc == 0
      failed_when: token_generation.rc != 0

    - name: Display token generation result
      debug:
        msg: "{{ 'Grafana API token generated successfully' if token_check.stdout == 'missing' else 'Grafana API token already exists' }}"

    - name: Wait for service health check
      wait_for:
        port: 8080
        host: "{{ ansible_host }}"
        timeout: 60
        delay: 10
      failed_when: false

    - name: Check service health
      uri:
        url: "http://{{ ansible_host }}:8080/health"
        method: GET
        status_code: 200
      register: health_check
      retries: 5
      delay: 10
      failed_when: false

    - name: Display deployment status
      debug:
        msg:
          - "Services started successfully"
          - "Health check: {{ 'PASSED' if health_check.status == 200 else 'FAILED' }}"
          - "Application URL: https://app-cuda-demo.josnelihurt.me"

    - name: Final service check
      shell: cd {{ app_directory }} && docker compose -f docker-compose.yml ps
      register: final_status
      changed_when: false

    - name: Display final status
      debug:
        msg: "{{ item }}"
      loop: "{{ final_status.stdout_lines }}"

