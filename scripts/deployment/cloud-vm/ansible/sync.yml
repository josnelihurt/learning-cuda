---
- name: Sync files to Cloud VM
  hosts: cloud
  tasks:
    - name: Get project root
      set_fact:
        project_root: "{{ playbook_dir | dirname | dirname | dirname | dirname }}"

    - name: Ensure application directory exists on remote
      file:
        path: "{{ app_directory }}"
        state: directory
        mode: '0755'

    - name: Sync project files with rsync
      synchronize:
        src: "{{ project_root }}"
        dest: "{{ app_directory }}"
        delete: no
        rsync_opts:
          - "--exclude=.git/"
          - "--exclude=.ignore/"
          - "--exclude=*.md"
          - "--exclude=bazel*"
          - "--exclude=bin/"
          - "--exclude=coverage/"
          - "--exclude=cpp_accelerator/"
          - "--exclude=webserver/web/node_modules"
          - "--exclude=third_party/"
          - "--exclude=venv-mcp/"
          - "--exclude=grpc-test/"
          - "--exclude=.cache/"
          - "--exclude=test-data/"
        mode: push
      