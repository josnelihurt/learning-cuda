#!/bin/bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

echo "Running pre-push build checks..."
echo ""

cd "$PROJECT_ROOT"

ensure_writable() {
  local relative_path="$1"
  local absolute_path="${PROJECT_ROOT}/${relative_path}"
  local uid gid owner group
  uid="$(id -u)"
  gid="$(id -g)"

  if [ ! -d "$absolute_path" ]; then
    if ! mkdir -p "$absolute_path" 2>/dev/null; then
      if command -v docker >/dev/null 2>&1; then
        docker run --rm -v "${PROJECT_ROOT}:/workspace" alpine:3.19 \
          sh -c "mkdir -p \"/workspace/${relative_path}\" && chown -R ${uid}:${gid} \"/workspace/${relative_path}\" && chmod -R u+rwX,g+rwX \"/workspace/${relative_path}\""
      else
        echo "Unable to create ${absolute_path}. Run 'sudo mkdir -p ${absolute_path}' and ensure it is owned by ${uid}:${gid}." >&2
        exit 1
      fi
    fi
  fi

  if owner="$(stat -c '%u' "$absolute_path" 2>/dev/null)"; then
    group="$(stat -c '%g' "$absolute_path" 2>/dev/null)"
  else
    owner="$(stat -f '%u' "$absolute_path")"
    group="$(stat -f '%g' "$absolute_path")"
  fi
  if [ "$owner" != "$uid" ] || [ "$group" != "$gid" ] || [ ! -w "$absolute_path" ]; then
    if command -v docker >/dev/null 2>&1; then
      docker run --rm -v "${absolute_path}:/target" alpine:3.19 \
        sh -c "chown -R ${uid}:${gid} /target && chmod -R u+rwX,g+rwX /target"
    else
      echo "Unable to adjust permissions for ${absolute_path}. Run 'sudo chown -R ${uid}:${gid} ${absolute_path}'." >&2
      exit 1
    fi
  fi
}

ensure_writable ".ignore/lib/cuda_learning"

echo "Building CUDA shared library..."
bazel build //cpp_accelerator/ports/shared_lib:libcuda_processor.so

VERSION=$(cat cpp_accelerator/VERSION)
TARGET_FILE=".ignore/lib/cuda_learning/libcuda_processor_v${VERSION}.so"

cp bazel-bin/cpp_accelerator/ports/shared_lib/libcuda_processor.so "$TARGET_FILE"
chmod 644 "$TARGET_FILE"

COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "dev")
DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

cat > .ignore/lib/cuda_learning/libcuda_processor_v${VERSION}.so.json <<EOF
{
  "name": "CUDA Image Processor",
  "version": "${VERSION}",
  "api_version": "2.1.0",
  "type": "gpu",
  "build_date": "${DATE}",
  "build_commit": "${COMMIT}",
  "description": "CUDA-accelerated image processing with CPU fallback"
}
EOF

echo ""
echo "Building Go server..."
(
  cd webserver
  make build
)

echo ""
echo "Building frontend..."
(
  cd webserver/web
  if [ ! -d node_modules ]; then
    npm install
  fi
  npm run build
)

echo ""
echo "Pre-push build checks completed successfully."
