#!/bin/bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

echo "Running pre-push build checks..."
echo ""

cd "$PROJECT_ROOT"

echo "Building CUDA shared library..."
bazel build //cpp_accelerator/ports/shared_lib:libcuda_processor.so

mkdir -p .ignore/lib/cuda_learning
VERSION=$(cat cpp_accelerator/VERSION)
TARGET_FILE=".ignore/lib/cuda_learning/libcuda_processor_v${VERSION}.so"

cp bazel-bin/cpp_accelerator/ports/shared_lib/libcuda_processor.so "$TARGET_FILE"
chmod 644 "$TARGET_FILE"

COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "dev")
DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

cat > .ignore/lib/cuda_learning/libcuda_processor_v${VERSION}.so.json <<EOF
{
  "name": "CUDA Image Processor",
  "version": "${VERSION}",
  "api_version": "2.1.0",
  "type": "gpu",
  "build_date": "${DATE}",
  "build_commit": "${COMMIT}",
  "description": "CUDA-accelerated image processing with CPU fallback"
}
EOF

echo ""
echo "Building Go server..."
(
  cd webserver
  make build
)

echo ""
echo "Building frontend..."
(
  cd webserver/web
  if [ ! -d node_modules ]; then
    npm install
  fi
  npm run build
)

echo ""
echo "Pre-push build checks completed successfully."
